#! /usr/bin/env bash

set -e

source script/env "$@"

# run tests
echo -e "\nüß™ ${BLUE}Running tests: $(date "+%H:%M:%S")${OFF}\n"

bundle exec bin/rspec spec && rspec_exit=$? || rspec_exit=$?

total_coverage=$(cat "$DIR/coverage/total-coverage.txt")

if grep -q "100.0" "$DIR/coverage/total-coverage.txt"; then
  cov_exit=0
  echo -e "\n‚úÖ Total Coverage: ${GREEN}$total_coverage${OFF}"
else
  cov_exit=1
  echo -e "\n‚ùå Total Coverage: ${RED}$total_coverage${OFF}"
fi

echo ""
echo "---------------------------------------"
echo "üìä Summary Results"
echo "---------------------------------------"
echo ""

if [[ $rspec_exit == 0 ]]; then
  echo -e "‚úÖ ${GREEN}rspec:    exitcode=${rspec_exit}${OFF}"
else
  echo -e "‚ùå ${RED}rspec:    exitcode=${rspec_exit}${OFF}"
fi

if [[ $cov_exit == 0 ]]; then
  echo -e "‚úÖ ${GREEN}coverage: exitcode=${cov_exit}${OFF}"
else
  echo -e "‚ùå ${RED}coverage: exitcode=${cov_exit}${OFF}"
fi

[ "$rspec_exit" -gt 0 ] && exit 1
[ $cov_exit -gt 0 ] && exit 1

exit 0
